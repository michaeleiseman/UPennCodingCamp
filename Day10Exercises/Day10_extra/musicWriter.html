<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Writer</title>
    <style>
        .relative{
            position: relative
        }
        #staff{
            border: 1px solid red;
            width: 1200px;
            height: 300px;
        }
        #trebelClef {
            position: absolute;
            top: 105px;
            left: 0px
        }
        
    </style>
</head>
<body>
    <button>Play</button>
    <div class="relative">
        <svg id="staff" viewBox="0 0 1200 300" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="120" x2="1200" y2="120" stroke="black"/>
            <line x1="0" y1="150" x2="1200" y2="150" stroke="black"/>
            <line x1="0" y1="180" x2="1200" y2="180" stroke="black"/>
            <line x1="0" y1="210" x2="1200" y2="210" stroke="black"/>
            <line x1="0" y1="240" x2="1200" y2="240" stroke="black"/>
        </svg>
        <svg id="trebelClef" viewBox="0 0 75 250" width="100" height="300">
            <path stroke="#000" d="m51.688 5.25c-5.427-0.1409-11.774 12.818-11.563 24.375 0.049 3.52 1.16 10.659 2.781 19.625-10.223 10.581-22.094 21.44-22.094 35.688-0.163 13.057 7.817 29.692 26.75 29.532 2.906-0.02 5.521-0.38 7.844-1 1.731 9.49 2.882 16.98 2.875 20.44 0.061 13.64-17.86 14.99-18.719 7.15 3.777-0.13 6.782-3.13 6.782-6.84 0-3.79-3.138-6.88-7.032-6.88-2.141 0-4.049 0.94-5.343 2.41-0.03 0.03-0.065 0.06-0.094 0.09-0.292 0.31-0.538 0.68-0.781 1.1-0.798 1.35-1.316 3.29-1.344 6.06 0 11.42 28.875 18.77 28.875-3.75 0.045-3.03-1.258-10.72-3.156-20.41 20.603-7.45 15.427-38.04-3.531-38.184-1.47 0.015-2.887 0.186-4.25 0.532-1.08-5.197-2.122-10.241-3.032-14.876 7.199-7.071 13.485-16.224 13.344-33.093 0.022-12.114-4.014-21.828-8.312-21.969zm1.281 11.719c2.456-0.237 4.406 2.043 4.406 7.062 0.199 8.62-5.84 16.148-13.031 23.719-0.688-4.147-1.139-7.507-1.188-9.5 0.204-13.466 5.719-20.886 9.813-21.281zm-7.719 44.687c0.877 4.515 1.824 9.272 2.781 14.063-12.548 4.464-18.57 21.954-0.781 29.781-10.843-9.231-5.506-20.158 2.312-22.062 1.966 9.816 3.886 19.502 5.438 27.872-2.107 0.74-4.566 1.17-7.438 1.19-7.181 0-21.531-4.57-21.531-21.875 0-14.494 10.047-20.384 19.219-28.969zm6.094 21.469c0.313-0.019 0.652-0.011 0.968 0 13.063 0 17.99 20.745 4.688 27.375-1.655-8.32-3.662-17.86-5.656-27.375z"/>
        </svg>
    </div>
    
   
    <script>
        let beat = 0;
        let noteIndicies = [40, 42, 44, 45, 47, 49, 51, 52, 54, 56, 57];
        let notes = [];
        let song = [];
        let selectedNote = null;
        let noteSpacing = 40;
        let tempo = 500;
        let quarterNoteDuration = 1500;
        let soundType = "square";
        let context;
        let timer;
        let o = null;
        let g = null;
        document.getElementsByTagName("button")[0].addEventListener('click', playSong, false);
        function playSong() {
            context = new AudioContext();
            let index = 0
            timer = setInterval(playNoteOfSong, tempo);
            playNote(440, soundType);

        }
        function playNoteOfSong() {
            let frequency = song[index].frequency
            setTimeout(function(){
                    o = context.createOscillator();
                    g = context.createGain();
                    o.type = type;
                    o.connect(g);
                    o.frequency.value = frequency;
                    g.connect(context.destination);
                    o.start(0);
                    g.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + quarterNoteDuration / 1000);
                }, 0);
                index++;
                if(index == song.length) {
                    clearInterval(timer);
                }
        }
        
        class Note {
            constructor (boundary, noteIndex, beat) {
                this.boundary = boundary;
                this.noteIndex = noteIndex;
                this.frequency = Math.pow(2, (this.noteIndex - 49) / 12) * 440;
                this.beat = beat;
                this.duration = null;
                this.modifier = null;
                this.noteBody = null;
                this.noteStem = null;
            }
            draw() {
                this.noteBody = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                let cx = (100 + beat * noteSpacing).toString();
                let cy = (180 - 10 * noteIndicies.indexOf(this.noteIndex)).toString();
                this.noteBody.setAttribute("cx", cx);
                this.noteBody.setAttribute("cy", cy);
                this.noteBody.setAttribute("rx", "13");
                this.noteBody.setAttribute("ry", "10");
                this.noteBody.setAttribute("transform", "rotate(-20 " + cx + " " + cy +")");
                document.getElementById("staff").appendChild(this.noteBody);
                this.noteBody.addEventListener('click', this.select, false);
                this.noteStem = document.createElementNS("http://www.w3.org/2000/svg", "line");
                let deltaX = 12;
                let deltaY = -50;
                if(this.noteIndex > 50) {
                    deltaX = -deltaX;
                    deltaY = -deltaY;
                }
                this.noteStem.setAttribute("x1", (Number(cx) + deltaX).toString());
                this.noteStem.setAttribute("y1", cy);
                this.noteStem.setAttribute("x2", (Number(cx) + deltaX).toString());
                this.noteStem.setAttribute("y2", (Number(cy) + deltaY).toString());
                this.noteStem.setAttribute("stroke-width", "2");
                this.noteStem.setAttribute("stroke", "black");
                document.getElementById("staff").appendChild(this.noteStem);
            }
            select(event) {
                if(selectedNote) {
                    selectedNote.noteBody.setAttribute("fill", "black");
                    selectedNote.noteStem.setAttribute("stroke", "black");
                }
                selectedNote = this;
                if(this.tagName) {
                    selectedNote = this.noteObject
                }
                selectedNote.noteBody.setAttribute("fill", "red");
                selectedNote.noteStem.setAttribute("stroke", "red");
            }

        }
        document.getElementById("staff").addEventListener("click", makeNote, false);
        function makeNote(event) {
            if(event.target !== document.getElementById("staff") && event.target.tagName != "line") {
                return;
            }
            let y = event.offsetY;
            if(event.target.tagName === "line") {
                y = Number(event.target.getAttribute("y1"));
            }
            let extent = Math.floor((y - 159) / 22)
            beat++;
            let note = new Note ( 159 + extent * 22, noteIndicies[10 - extent], beat);
            notes.push(note);
            note.draw();
            note.noteBody.noteObject = note;
            note.select();
        }
    </script>
</body>
</html>