<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Writer</title>
    <style>
        .relative{
            position: relative
        }
        #staff{
            border: 1px solid red;
            width: 1200px;
            height: 300px;
        }
        #trebelClef {
            position: absolute;
            top: 105px;
            left: 0px
        }
        form {
            display: inline-flex;
            width: 400px;
            justify-content: space-between;
        }
        
    </style>
</head>
<body>
    <button>Play</button>
    <form class="flex">
        <div>
            <input id="eighth" type="radio" name="duration" value="0.5">
            <label for="eighth">
                <svg viewBox="0 0 30 55" width="30" height="55">
                    <ellipse cx="11" cy="47" rx="9" ry="7" transform="rotate(-20 11 47)"></ellipse>
                    <line x1="19" y1="45" x2="19" y2="0" stroke-width="2" stroke="black"></line>
                    <path d="M 20 0 H 21 C 21.05 1.65, 21.1 2.45 22.45 4.95 S 28.5 10.65 28.85 14.75 S 27.65 22, 26.1 25 L 25.3 24.75 C 27.7 21.85, 28.1 18.3 28 16.2 S 25.15 7.85 20 8.9 Z"/>
                </svg>
            </label>
        </div>
        <div>
            <input id="quarter" type="radio" name="duration" value="1" checked>
            <label for="quarter">
                <svg viewBox="0 0 22 55" width="22" height="55">
                    <ellipse cx="11" cy="47" rx="9" ry="7" transform="rotate(-20 11 47)"></ellipse>
                    <line x1="19" y1="45" x2="19" y2="0" stroke-width="2" stroke="black"></line>
                </svg>
            </label>
        </div>
        <div>
            <input id="half" type="radio"  name="duration" value="2">
            <label for="half">
                <svg viewBox="0 0 22 55" width="22" height="55">
                    <mask id="hm">
                        <rect x="0" y="35" width="55" height="22" fill="white"></rect>
                        <ellipse cx="11" cy="47" rx="6" ry="2.5" transform="rotate(-20 11 47)" fill="black"></ellipse>
                    </mask>
                    <ellipse cx="11" cy="47" rx="9" ry="7" transform="rotate(-20 11 47)" mask="url(#hm)"/>
                    <line x1="19" y1="45" x2="19" y2="0" stroke-width="2" stroke="black"></line>
                </svg>
            </label>
        </div>
        <div>
            <input id="whole" type="radio"  name="duration" value="4">
            <label for="whole">
                <svg viewBox="0 0 22 55" width="22" height="55">
                    <mask id="wm">
                        <rect x="0" y="35" width="55" height="22" fill="white"></rect>
                        <ellipse cx="11" cy="47" rx="6" ry="4" transform="rotate(60 11 47)" fill="black"></ellipse>
                    </mask>
                    <ellipse cx="11" cy="47" rx="9" ry="7" mask="url(#wm)"/>
                </svg>
            </label>
        </div>
    </form>    
    <div class="relative">
        <svg id="staff" viewBox="0 0 1200 300" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="120" x2="1200" y2="120" stroke="black"/>
            <line x1="0" y1="150" x2="1200" y2="150" stroke="black"/>
            <line x1="0" y1="180" x2="1200" y2="180" stroke="black"/>
            <line x1="0" y1="210" x2="1200" y2="210" stroke="black"/>
            <line x1="0" y1="240" x2="1200" y2="240" stroke="black"/>
            <defs>
                <g id="eighthNote">
                    <ellipse cx="0" cy="0" rx="18" ry="14" transform="rotate(-20 0 0)"/>
                </g>
                <g id="quarterNote">
                    <ellipse cx="0" cy="0" rx="18" ry="14" transform="rotate(-20 0 0)"/>
                </g>
                <g id="halfNote">
                    <mask id="halfMask">
                        <rect x="-22" y="-20" width="44" height="40" fill="white"></rect>
                        <ellipse cx="0" cy="0" rx="13" ry="5" transform="rotate(-20 0 0)" fill="black"></ellipse>
                    </mask>
                    <ellipse cx="0" cy="0" rx="18" ry="14" transform="rotate(-20 0 0)" mask="url(#halfMask)"/>
                </g>
                <g id="wholeNote">
                    <mask id="wholeMask">
                        <rect x="-22" y="-20" width="44" height="40" fill="white"></rect>
                        <ellipse cx="0" cy="0" rx="13" ry="8" transform="rotate(60 0 0)" fill="black"></ellipse>
                    </mask>
                    <ellipse cx="0" cy="0" rx="20" ry="15" mask="url(#wholeMask)"/>
                </g>
                <path id="upFlag" d="M 0 0 H 2 C 2.1 2.3, 2.2 4.9 4.9 9.9 S 17 21.3 17.7 29.5 S 15.3 44, 12.2 50.0 L 10.6 49.5 C 15.4 43.7, 16.2 36.6 16 32.4 S 10.3 15.7 0 17.8 Z"/>
                <path id="downFlag" d="M 0 50 H 2 C 2.1 47.7, 2.2 45.1 4.9 40.1 S 17 28.7 17.7 20.5 S 15.3 6, 12.2 0 L 10.6 0.5 C 15.4 6.3, 16.2 13.4 16 17.6 S 10.3 34.3 0 32.2 Z"/>
            </defs>
        </svg>
        <svg id="trebelClef" viewBox="0 0 75 250" width="100" height="300">
            <path stroke="#000" d="m51.688 5.25c-5.427-0.1409-11.774 12.818-11.563 24.375 0.049 3.52 1.16 10.659 2.781 19.625-10.223 10.581-22.094 21.44-22.094 35.688-0.163 13.057 7.817 29.692 26.75 29.532 2.906-0.02 5.521-0.38 7.844-1 1.731 9.49 2.882 16.98 2.875 20.44 0.061 13.64-17.86 14.99-18.719 7.15 3.777-0.13 6.782-3.13 6.782-6.84 0-3.79-3.138-6.88-7.032-6.88-2.141 0-4.049 0.94-5.343 2.41-0.03 0.03-0.065 0.06-0.094 0.09-0.292 0.31-0.538 0.68-0.781 1.1-0.798 1.35-1.316 3.29-1.344 6.06 0 11.42 28.875 18.77 28.875-3.75 0.045-3.03-1.258-10.72-3.156-20.41 20.603-7.45 15.427-38.04-3.531-38.184-1.47 0.015-2.887 0.186-4.25 0.532-1.08-5.197-2.122-10.241-3.032-14.876 7.199-7.071 13.485-16.224 13.344-33.093 0.022-12.114-4.014-21.828-8.312-21.969zm1.281 11.719c2.456-0.237 4.406 2.043 4.406 7.062 0.199 8.62-5.84 16.148-13.031 23.719-0.688-4.147-1.139-7.507-1.188-9.5 0.204-13.466 5.719-20.886 9.813-21.281zm-7.719 44.687c0.877 4.515 1.824 9.272 2.781 14.063-12.548 4.464-18.57 21.954-0.781 29.781-10.843-9.231-5.506-20.158 2.312-22.062 1.966 9.816 3.886 19.502 5.438 27.872-2.107 0.74-4.566 1.17-7.438 1.19-7.181 0-21.531-4.57-21.531-21.875 0-14.494 10.047-20.384 19.219-28.969zm6.094 21.469c0.313-0.019 0.652-0.011 0.968 0 13.063 0 17.99 20.745 4.688 27.375-1.655-8.32-3.662-17.86-5.656-27.375z"/>
        </svg>
    </div>
    
   
    <script>
        let noteIndicies = [40, 42, 44, 45, 47, 49, 51, 52, 54, 56, 57];
        let song = [];
        let selectedNote = null;
        let noteSpacing = 60;
        let tempo = 0.3;
        let soundType = "square";

        let timer;
        let index;
        let mouseIsDown = false;
        let songIsPlaying = false;
        let userHasInitiatedAudio = false;
        let noteEnvelope = 0.01;
        let context;
        let o;
        let g;
        
        function initializeAudio() {
            context = new AudioContext();
            o = context.createOscillator();
            g = context.createGain();
            o.type = soundType;
            o.connect(g);
            g.connect(context.destination);
            o.start(context.currentTime);
            g.gain.setValueAtTime(0, context.currentTime);
            userHasInitiatedAudio = true;
        }
        document.getElementsByTagName("button")[0].addEventListener('click', playSong, false);
        for(let input of document.getElementsByTagName("input")) {
            input.addEventListener('change', changeNoteDuration, false)
        }
        function changeNoteDuration() {
            if(!selectedNote) {
                return;
            }
            let oldDuration = selectedNote.duration;
            let newDuration = Number(this.value) * tempo;
            selectedNote.noteBody.setAttribute("href", "#" + this.id + "Note");
            selectedNote.duration = newDuration;
            if(oldDuration < 4 * tempo && newDuration === 4 * tempo) {
                document.getElementById("staff").removeChild(selectedNote.noteStem);
            } else if(oldDuration === 4 * tempo && newDuration < 4 * tempo) {
                document.getElementById("staff").appendChild(selectedNote.noteStem);
            }
            if(oldDuration > 0.5 * tempo && newDuration === 0.5 * tempo) {
                document.getElementById("staff").appendChild(selectedNote.noteFlag);
            } else if(oldDuration == 0.5 * tempo && newDuration > 0.5 * tempo) {
                document.getElementById("staff").removeChild(selectedNote.noteFlag);
            }
            selectedNote.type = selectedNote.noteBody.getAttribute("href");
        }
        function playSong() {
            if(song.length === 0) {
                return;
            }
            songIsPlaying = true;
            if(selectedNote) {
                selectedNote.deselect();
            }
            let timing = 0;
            for(let note of song) {
                note.start = timing
                o.frequency.setValueAtTime(note.frequency(), context.currentTime + note.start);
                g.gain.setValueAtTime(1, context.currentTime + note.start + noteEnvelope);
                g.gain.setValueAtTime(0, context.currentTime + note.start + note.duration - noteEnvelope);
                timing = timing + note.duration;
            }
            for(let note of song) {
                setTimeout(function() {note.select()}, note.start * 1000);
            }
            let lastNote = song[song.length - 1];
            setTimeout(function() {
                lastNote.deselect();
                songIsPlaying = false
            }, (lastNote.start + lastNote.duration) * 1000);
        }
        class Note {
            constructor (boundary, noteIndex, type, duration) {
                this.boundary = boundary;
                this.noteIndex = noteIndex;
                this.frequency = function () { return Math.pow(2, (this.noteIndex - 49) / 12) * 440;}
                this.start = 0;
                this.type = type;
                this.duration = duration;
                this.modifier = null;
                this.noteBody = null;
                this.noteStem = null;
                this.noteFlag = null;
            }
            draw() {
                this.noteBody = document.createElementNS("http://www.w3.org/2000/svg", "use");
                this.noteBody.setAttribute("href", this.type);
                let cx = (120 + song.indexOf(this) * noteSpacing).toString();
                let cy = (270 - 15 * noteIndicies.indexOf(this.noteIndex)).toString();
                this.noteBody.setAttribute("x", cx);
                this.noteBody.setAttribute("y", cy);
                document.getElementById("staff").appendChild(this.noteBody);
                this.noteBody.addEventListener('mousedown', this.select, false);
                this.noteBody.addEventListener('drag', this.changePitch, false);
                this.noteStem = document.createElementNS("http://www.w3.org/2000/svg", "line");
                this.noteFlag = document.createElementNS("http://www.w3.org/2000/svg", "use");
                this.noteFlag.setAttribute("href", "#upFlag");
                let deltaX = 16;
                let deltaY = -90;
                let flagDelta = 0
                if(this.noteIndex > 50) {
                    deltaX = -deltaX;
                    deltaY = -deltaY;
                    this.noteFlag.setAttribute("href", "#downFlag");
                    flagDelta = -50;
                }
                this.noteStem.setAttribute("x1", (Number(cx) + deltaX).toString());
                this.noteStem.setAttribute("y1", cy);
                this.noteStem.setAttribute("x2", (Number(cx) + deltaX).toString());
                this.noteStem.setAttribute("y2", (Number(cy) + deltaY).toString());
                this.noteStem.setAttribute("stroke-width", "3");
                this.noteStem.setAttribute("stroke", "black");
                this.noteFlag.setAttribute("x", (Number(cx) + deltaX).toString());
                this.noteFlag.setAttribute("y", (Number(cy) + deltaY + flagDelta).toString());
                if(this.duration < 4 * tempo) {
                    document.getElementById("staff").appendChild(this.noteStem);
                }
                if(this.duration === 0.5 * tempo) {
                    document.getElementById("staff").appendChild(this.noteFlag);
                }
                
            }
            select(event) {
                if(event) {
                    mouseIsDown = true;
                }
                if(selectedNote) {
                    selectedNote.noteBody.setAttribute("fill", "black");
                    selectedNote.noteStem.setAttribute("stroke", "black");
                    selectedNote.noteFlag.setAttribute("fill", "black");
                }
                selectedNote = this;
                if(this.tagName) {
                    selectedNote = this.noteObject
                }
                selectedNote.noteBody.setAttribute("fill", "red");
                selectedNote.noteStem.setAttribute("stroke", "red");
                selectedNote.noteFlag.setAttribute("fill", "red");
                if(mouseIsDown) {
                    selectedNote.play();
                }
                document.getElementById(selectedNote.type.slice(1, -4)).checked = true;
                
            }
            deselect() {
                mouseIsDown = false;
                if(selectedNote) {
                    selectedNote.noteBody.setAttribute("fill", "black");
                    selectedNote.noteStem.setAttribute("stroke", "black");
                    selectedNote.noteFlag.setAttribute("fill", "black");
                }
                selectedNote = null;
            }
            isSelected() {
                if(selectedNote === this) {
                    return true;
                }
                return false;
            }
            changePitch(event) {
                if(!mouseIsDown) {
                    return
                }
                let y = event.offsetY;
                let originalBoundary = selectedNote.boundary
                let extent = Math.floor((y - 113) / 15);
                let currentBoundary = 113 + extent * 15;
                if(originalBoundary != currentBoundary) {
                    selectedNote.boundary = currentBoundary
                    selectedNote.noteIndex = noteIndicies[10 - extent];
                    let cy = (270 - 15 * noteIndicies.indexOf(selectedNote.noteIndex)).toString();
                    let cx = selectedNote.noteBody.getAttribute("x");
                    selectedNote.noteBody.setAttribute("y", cy);
                    selectedNote.noteFlag.setAttribute("href", "#upFlag")
                    let deltaX = 16;
                    let deltaY = -90;
                    let flagDelta = 0;
                    if(selectedNote.noteIndex > 50) {
                        deltaX = -deltaX;
                        deltaY = -deltaY;
                        selectedNote.noteFlag.setAttribute("href", "#downFlag");
                        flagDelta = -50;
                    }
                    selectedNote.noteStem.setAttribute("x1", (Number(cx) + deltaX).toString());
                    selectedNote.noteStem.setAttribute("y1", cy);
                    selectedNote.noteStem.setAttribute("x2", (Number(cx) + deltaX).toString());
                    selectedNote.noteStem.setAttribute("y2", (Number(cy) + deltaY).toString());
                    selectedNote.noteFlag.setAttribute("y", (Number(cy) + deltaY + flagDelta).toString());
                    selectedNote.noteFlag.setAttribute("x", (Number(cx) + deltaX).toString());
                    selectedNote.start = 0;
                    selectedNote.play();
                }
            }
            play() {
                if(!userHasInitiatedAudio) {
                    initializeAudio();
                }
                o.frequency.setValueAtTime(this.frequency(), context.currentTime);
                g.gain.setValueAtTime(1, context.currentTime  + noteEnvelope);
                g.gain.setValueAtTime(0, context.currentTime + this.duration - noteEnvelope);
            }

        }
        document.getElementById("staff").addEventListener("mousedown", makeNote, false);
        document.getElementById("staff").addEventListener("mouseup", mouseIsUp, false);
        document.getElementById("staff").addEventListener('mousemove', function(event) {
            if(!selectedNote || !mouseIsDown || songIsPlaying) {
                return
            }
            selectedNote.changePitch(event);
        }, false);
        function makeNote(event) {
            if(!userHasInitiatedAudio) {
                initializeAudio();
            }
            if(event.target !== document.getElementById("staff") && event.target.tagName != "line") {
                return;
            }
            let y = event.offsetY;
            if(event.target.tagName === "line") {
                y = Number(event.target.getAttribute("y1"));
            }
            let extent = Math.floor((y - 113) / 15);
            let noteIndex = noteIndicies[10 - extent];
            if(noteIndex != -1) {
                let durationSelection = document.querySelector("input:checked");
                let note = new Note ( 113 + extent * 15, noteIndicies[10 - extent], "#" + durationSelection.id + "Note", Number(durationSelection.value) * tempo);
                song.push(note);
                note.draw();
                note.noteBody.noteObject = note;
                note.play();
                note.select();
            }
        }
        function mouseIsUp() {
            mouseIsDown = false;
        }
    </script>
</body>
</html>